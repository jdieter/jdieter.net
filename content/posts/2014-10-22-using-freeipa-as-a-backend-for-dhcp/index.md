---
title: Using FreeIPA as a backend for DHCP
author: jdieter
type: post
date: 2014-10-22T18:52:47+00:00
url: /posts/2014/10/22/using-freeipa-as-a-backend-for-dhcp
categories:
  - Computers
tags:
  - dhcp
  - DHCP server
  - dns
  - DNS entries
  - DNS server
  - fedora
  - freeipa
  - ldap

---
{{< imgproc "4482491295_6e68ece464_o" Resize "300x" >}}Yeah, this&#8230;{{< /imgproc >}}

_Disclaimer:_ This is **not** an official guide and in no way represents best practices for FreeIPA. It is ugly and involves the digital equivalent of bashing on screws with a hammer. Having said that, when nobody has invented the right screwdriver yet, sometimes you just have to hammer away.

First, some history. We&#8217;ve been running separate DHCP, DNS and LDAP servers since we switched from static IP addresses and a Windows NT domain somewhere around ten years ago. The DHCP server was loosely connected with the DNS server, and I had written this beautifully complex (read: messily unreadable) script that would allow you to quickly add a system to both DHCP and DNS. A few months ago, we migrated all of our users over to FreeIPA, and I started the process of migrating our DNS database over. Unfortunately, this meant that our DHCP fixed addresses were being configured separately from our DNS entries.

Last week I investigated what it would take to integrate our DHCP leases into FreeIPA. First I checked on the web to see if something like this had already been written, but the closest thing I could find was a link to [a design page][2] for a feature that&#8217;s due to appear in FreeIPA 4.x.

So here&#8217;s my (admittedly hacky) contribution:

  1. [`sync_dhcp`][3] &#8211; A bash script (put in `/srv`, chmod +x)that constantly checks whether the DNS zone&#8217;s serial number has changed, and, if it has, runs&#8230;
  2. [`generate_dhcp.py`][4] &#8211; A python script (put in `/srv`, chmod +x) that regenerates a list of fixed-addresses in `/etc/dhcp/hosts.conf`
  3. [`dhcpd.conf`][5] &#8211; A sample dhcpd.conf (put in `/etc/dhcp`) that uses the list generated by `generate_dhcp.py`
  4. [`sync-dhcp.service`][6] &#8211; A systemd service (put in `/etc/systemd/system`) to run `sync_dhcp` on bootup
  5. [`make_dns`][7] &#8211; A script (chmod +x) that allows the sysadmin to easily add new dns entries with a mac address

`sync_dhcp` does need to know your domain so it knows which DNS zone serial to check, but other than that, the first four files should work with little or no modification. You will need to create a dnsserver user in FreeIPA, give the user read access to DNS entries, and put its password in /etc/dhcp/dnspasswd (readable only by root).

`make_dns` makes a number of assumptions that are true of our network, but may not be true of yours. It first assumes that you&#8217;re using a 10.10.0.0/16 network (yes, I know that&#8217;s not right; it&#8217;s long story) and that 10.10.9.x and 10.10.10.x IPs are for unrecognized systems. It also requires that you&#8217;ve installed `freeipa-admintools` and run kinit for a user with permissions to change DNS entries, as it&#8217;s just basically a fancy wrapper around the IPA cli tools.

**[Bent Screw Hole Backyard Metal Macros][8] by [Steven Depolo][9] used under a [CC BY 2.0][10] license**

 [2]: http://www.freeipa.org/page/DHCP_Integration_Design
 [3]: http://lesloueizeh.com/jdieter/freeipa-dhcpd/sync_dhcp
 [4]: http://lesloueizeh.com/jdieter/freeipa-dhcpd/generate_dhcp.py
 [5]: http://lesloueizeh.com/jdieter/freeipa-dhcpd/dhcpd.conf
 [6]: http://lesloueizeh.com/jdieter/freeipa-dhcpd/sync-dhcp.service
 [7]: http://lesloueizeh.com/jdieter/freeipa-dhcpd/make_dns
 [8]: https://www.flickr.com/photos/stevendepolo/4482491295/
 [9]: https://www.flickr.com/photos/stevendepolo/
 [10]: http://creativecommons.org/licenses/by/2.0/
